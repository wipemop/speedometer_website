on:  
  push:  
    branches:  
      - main  
  pull_request:  
    types: [opened, reopened, synchronize, closed]

jobs:
  publish:
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'pull_request' && github.event.pull_request.merged == false)
    runs-on: ubuntu-latest  
    defaults:  
      run:  
        working-directory: ./
    permissions:  
      contents: read
      pull-requests: write
      deployments: write  
    name: Publish to Cloudflare Pages  
    steps:  
      - name: Checkout  
        uses: actions/checkout@v3  

      - name: Set Node.js 20.x  
        uses: actions/setup-node@v3  
        with:  
          node-version: 20.x  

      - name: Setup Yarn  
        run: npm install -g yarn  

      - name: Run install  
        run: yarn install --immutable  

      - name: Build production bundle  
        run: yarn build  
        env:  
          NITRO_PRESET: cloudflare-pages

      - name: Determine Cloudflare Project Name  
        id: determine_project  
        run: |  
          echo "PROJECT_NAME=speedometer" >> $GITHUB_ENV  
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then  
            echo "PROJECT_NAME=pr${{ github.event.pull_request.number }}-speedometer" >> $GITHUB_ENV  
          fi  

      - name: Create Cloudflare Pages Project (if PR)
        if: startsWith(env.PROJECT_NAME, 'pr')
        continue-on-error: true
        uses: cloudflare/wrangler-action@v3  
        with:  
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}  
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}  
          command: pages project create ${{ env.PROJECT_NAME }} --production-branch HEAD

          
      - name: Publish to Cloudflare Pages  
        uses: cloudflare/wrangler-action@v3  
        with:  
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}  
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}  
          command: pages deploy ./dist --project-name ${{ env.PROJECT_NAME }}
          
      - name: Comment on PR with Preview Link  
        if: github.event_name == 'pull_request'  
        uses: actions/github-script@v6  
        with:  
          github-token: ${{ secrets.GITHUB_TOKEN }}  
          script: |  
            github.rest.issues.createComment({  
              issue_number: ${{ github.event.pull_request.number }},  
              owner: context.repo.owner,  
              repo: context.repo.repo,  
              body: "ðŸš€ Preview deployed: [${{ env.PROJECT_NAME }}.pages.dev](https://${{ env.PROJECT_NAME }}.pages.dev)"  
            });

  cleanup:  
    if: github.event_name == 'pull_request' && github.event.pull_request.merged == true  
    runs-on: ubuntu-latest  
    steps:  
      - name: Delete Cloudflare Preview Deployment  
        uses: cloudflare/wrangler-action@v3  
        with:  
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}  
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}  
          command: pages project delete pr${{ github.event.pull_request.number }}-speedometer
